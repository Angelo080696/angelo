"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7847],{6901:(t,e,n)=>{n.d(e,{p:()=>r});var o=n(22905),s=n(47665);let r=o.YY.create({name:"generateCard",addCommands:()=>({removeGeneratorInputsOnLoad:()=>t=>{let{tr:e,state:n,editor:r}=t;return!!r.isEditable&&((0,o.xe)(n.doc,t=>{var e;return(0,s.jg)(t)&&(null==(e=t.attrs.generatorInput)?void 0:e.status)==="done"}).forEach(t=>{let{pos:n}=t;e.setNodeAttribute(n,"generatorInput",null)}),!0)}})})},8294:(t,e,n)=>{n.d(e,{A:()=>i,q:()=>a});var o=n(22905),s=n(63867),r=n(61385);let a=o.YY.create({name:"scrollMargin",addProseMirrorPlugins:()=>[new s.k_({props:{scrollMargin:r.E0,scrollThreshold:r.E0}})]}),i=a},14083:(t,e,n)=>{n.d(e,{R:()=>r});var o=n(22905),s=n(50764);let r=o.YY.create({name:"BlockHover",addProseMirrorPlugins(){return[(0,s.bA)(this.editor)]}})},14607:(t,e,n)=>{n.d(e,{r:()=>u});var o=n(22905),s=n(81807),r=n(80116),a=n(40029),i=n(33201),l=n(15769),d=n(47956),c=n(26764);class u{static findCardById(t,e){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=this.findTopLevelCards(t).find(t=>t.cardId===e);if(!o)throw Error("Cannot find card with id ".concat(e));return n&&this.focusCard(t,o.pos),o}static async replaceCardById(t,e,n,o){let r=(0,s.DB)(o),i=await (0,l.Y)(r,{imageOptions:(0,c.I)(e,t),cardId:n}),h=u.findCardById(t,n),p=h.pos,m={from:p,to:p+t.state.doc.nodeAt(h.pos).nodeSize};t.chain().setMeta("cardNotesHandled",!0).insertContentAt(m,i).selectInsideCardBody(p).run();let f=(0,d.u0)(e.getState());return(0,a.de)(t,t.state.doc,f),{newHtml:r,replaceRange:m}}static getCurrentFocusedCard(t,e){let n=(0,d.lh)(e.getState());if(!n||"card"!==n.type)throw Error("Cannot find currently focused card");let o=n.cardId,s=this.findCardById(t,n.cardId);if(!s)throw Error("Cannot find card with id ".concat(o));let a=t.state.doc.nodeAt(s.pos),i=(0,r.K)(t,a);return{cardId:o,cardNum:s.cardNum,html:i}}static focusCard(t,e){t.commands.selectInsideCardBody(e)}static findTopLevelCards(t){return(0,o.xe)(t.state.doc,t=>(0,i.jg)(t)).filter(e=>1===t.state.doc.resolve(e.pos).depth).map((e,n)=>({pos:e.pos,node:e.node,cardNum:n+1,cardId:e.node.attrs.id,cardHtml:(0,r.K)(t,e.node)}))}static findCardNum(t,e){let n=this.findTopLevelCards(t).find(t=>t.cardId===e);if(!n)throw Error("Cannot find card with id ".concat(e));return n.cardNum}static findCreateCardInsertRange(t,e){let n=this.findTopLevelCards(t),o=e-1,s=n[o];if(o===n.length){let e=t.state.doc.nodeAt(n[o-1].pos),s=n[o-1].pos+e.nodeSize;return{from:s,to:s}}if(!s)throw Error("Cannot find card with index ".concat(o));return{from:s.pos,to:s.pos}}}},15769:(t,e,n)=>{n.d(e,{Y:()=>d,S:()=>c});var o=n(22905),s=n(6813),r=n(45611),a=n(20178),i=n(66607);let l=t=>"card"===t.type,d=async(t,e)=>{let n=await c(t,e);if(Array.isArray(n)&&(n=n[0]),!l(n))throw Error("Expected content to be a card");return n.attrs.id=e.cardId,n},c=async(t,e)=>{let n=e.imageOptions||{},l=await (0,r.eY)(t,{imageOptions:n,loadImages:!0}),d=(0,o._w)((0,a.C)()),{content:c}=(0,i.S)(l,d),u=c.toJSON();for(let t of u)n&&"aiGenerated"===n.provider&&(0,s.gZ)(t,d),"card"===t.type&&(0,s.wJ)(t);return u}},26764:(t,e,n)=>{n.d(e,{I:()=>r});var o=n(90010),s=n(43634);let r=(t,e)=>{var n;let r=t.getState(),a=(null==(n=(0,o.lI)(e).aiOptions)?void 0:n.imageOptions)||{},i=(0,s.SJ)(r),l=a.license||"All",d=a.provider||"aiGenerated",c=a.generateStyle||i.config.stylePrompt||"";return{license:l,provider:d,generateStyle:c,model:a.model||"flux-1-schnell"}}},29586:(t,e,n)=>{n.d(e,{e:()=>f});var o=n(22905),s=n(3704),r=n(63867),a=n(97255),i=n(13691),l=n(14607),d=n(47956),c=n(22249),u=n(15342),h=n(15607),p=n(47665);let m=(t,e)=>new r.k_({props:{attributes:()=>{let t=(0,d.lh)((0,u.KA)().getState()),n=(null==t?void 0:t.type)==="deck";return e.salPanelOpen?{class:(0,s.cx)("sal-active",n&&"buddy-active-deck")}:{class:""}},decorations:n=>{let{doc:o,selection:m}=n;if(!t.isEditable)return;let{from:f,to:g}=m,A=[],v=(0,u.KA)().getState(),y=(0,i.yZ)(v);if((0,c.iZ)("image-chat")(v)&&y&&m instanceof r.nh)return A.push(a.NZ.node(m.from,m.to,{class:"is-selecting-node"})),a.zF.create(o,A);if(!e.salPanelOpen)return;let w=(0,d.lh)(v);return(null==w?void 0:w.type)==="deck"?l.r.findTopLevelCards(t).map(t=>{A.push(a.NZ.node(t.pos,t.pos+t.node.nodeSize,{class:(0,s.cx)("buddy-edit-deck")}))}):((0,h.IV)(m.$from,p.jg).forEach((t,e)=>{A.push(a.NZ.node(t.pos,t.pos+t.node.nodeSize,{class:(0,s.cx)(0==e?"sal-active-card":"sal-active-card-parent")}))}),(0,h.We)(t)||(m instanceof r.U3?A.push(a.NZ.inline(f,g,{class:(0,s.cx)("sal-selection-text")})):m instanceof r.nh&&A.push(a.NZ.node(f,g,{class:(0,s.cx)("sal-selection-node")})))),a.zF.create(o,A)}}}),f=o.YY.create({name:"salExtension",addStorage:()=>({salPanelOpen:!1}),addProseMirrorPlugins(){return[m(this.editor,this.storage)]},addCommands(){return{setSalOpen:t=>e=>{let{state:n,dispatch:o}=e;return this.storage.salPanelOpen=t,!0}}}})},39891:(t,e,n)=>{n.d(e,{Ay:()=>I,o5:()=>I});var o=n(22905);let s=t=>(0,o.Yp)({find:/--$/,replace:null!=t?t:"—"}),r=t=>(0,o.Yp)({find:/\.\.\.$/,replace:null!=t?t:"…"}),a=t=>(0,o.Yp)({find:/(?:^|[\s{[(<'"\u2018\u201C])(")$/,replace:null!=t?t:"“"}),i=t=>(0,o.Yp)({find:/"$/,replace:null!=t?t:"”"}),l=t=>(0,o.Yp)({find:/(?:^|[\s{[(<'"\u2018\u201C])(')$/,replace:null!=t?t:"‘"}),d=t=>(0,o.Yp)({find:/'$/,replace:null!=t?t:"’"}),c=t=>(0,o.Yp)({find:/<-$/,replace:null!=t?t:"←"}),u=t=>(0,o.Yp)({find:/->$/,replace:null!=t?t:"→"}),h=t=>(0,o.Yp)({find:/\(c\)$/,replace:null!=t?t:"\xa9"}),p=t=>(0,o.Yp)({find:/\(tm\)$/,replace:null!=t?t:"™"}),m=t=>(0,o.Yp)({find:/\(sm\)$/,replace:null!=t?t:"℠"}),f=t=>(0,o.Yp)({find:/\(r\)$/,replace:null!=t?t:"\xae"}),g=t=>(0,o.Yp)({find:/(?:^|\s)(1\/2)\s$/,replace:null!=t?t:"\xbd"}),A=t=>(0,o.Yp)({find:/\+\/-$/,replace:null!=t?t:"\xb1"}),v=t=>(0,o.Yp)({find:/!=$/,replace:null!=t?t:"≠"}),y=t=>(0,o.Yp)({find:/<<$/,replace:null!=t?t:"\xab"}),w=t=>(0,o.Yp)({find:/>>$/,replace:null!=t?t:"\xbb"}),M=t=>(0,o.Yp)({find:/\d+\s?([*x])\s?\d+$/,replace:null!=t?t:"\xd7"}),b=t=>(0,o.Yp)({find:/\^2$/,replace:null!=t?t:"\xb2"}),k=t=>(0,o.Yp)({find:/\^3$/,replace:null!=t?t:"\xb3"}),S=t=>(0,o.Yp)({find:/(?:^|\s)(1\/4)\s$/,replace:null!=t?t:"\xbc"}),C=t=>(0,o.Yp)({find:/(?:^|\s)(3\/4)\s$/,replace:null!=t?t:"\xbe"}),I=o.YY.create({name:"typography",addOptions:()=>({closeDoubleQuote:"”",closeSingleQuote:"’",copyright:"\xa9",ellipsis:"…",emDash:"—",laquo:"\xab",leftArrow:"←",multiplication:"\xd7",notEqual:"≠",oneHalf:"\xbd",oneQuarter:"\xbc",openDoubleQuote:"“",openSingleQuote:"‘",plusMinus:"\xb1",raquo:"\xbb",registeredTrademark:"\xae",rightArrow:"→",servicemark:"℠",superscriptThree:"\xb3",superscriptTwo:"\xb2",threeQuarters:"\xbe",trademark:"™"}),addInputRules(){let t=[];return!1!==this.options.emDash&&t.push(s(this.options.emDash)),!1!==this.options.ellipsis&&t.push(r(this.options.ellipsis)),!1!==this.options.openDoubleQuote&&t.push(a(this.options.openDoubleQuote)),!1!==this.options.closeDoubleQuote&&t.push(i(this.options.closeDoubleQuote)),!1!==this.options.openSingleQuote&&t.push(l(this.options.openSingleQuote)),!1!==this.options.closeSingleQuote&&t.push(d(this.options.closeSingleQuote)),!1!==this.options.leftArrow&&t.push(c(this.options.leftArrow)),!1!==this.options.rightArrow&&t.push(u(this.options.rightArrow)),!1!==this.options.copyright&&t.push(h(this.options.copyright)),!1!==this.options.trademark&&t.push(p(this.options.trademark)),!1!==this.options.servicemark&&t.push(m(this.options.servicemark)),!1!==this.options.registeredTrademark&&t.push(f(this.options.registeredTrademark)),!1!==this.options.oneHalf&&t.push(g(this.options.oneHalf)),!1!==this.options.plusMinus&&t.push(A(this.options.plusMinus)),!1!==this.options.notEqual&&t.push(v(this.options.notEqual)),!1!==this.options.laquo&&t.push(y(this.options.laquo)),!1!==this.options.raquo&&t.push(w(this.options.raquo)),!1!==this.options.multiplication&&t.push(M(this.options.multiplication)),!1!==this.options.superscriptTwo&&t.push(b(this.options.superscriptTwo)),!1!==this.options.superscriptThree&&t.push(k(this.options.superscriptThree)),!1!==this.options.oneQuarter&&t.push(S(this.options.oneQuarter)),!1!==this.options.threeQuarters&&t.push(C(this.options.threeQuarters)),t}})},46794:(t,e,n)=>{n.d(e,{$:()=>r});var o=n(22905),s=n(36271);let r=o.YY.create({name:"draftComments",addCommands:()=>({removeDraftComments:t=>e=>{let{dispatch:n,tr:o}=e;if(n){let e={type:"removeDraftComment",comments:Array.isArray(t)?t:[t]};o.setMeta(s._,e),n(o)}return!0},createDraftComment:t=>e=>{let{dispatch:n,tr:o}=e;return n&&(o.setMeta(s._,{type:"createDraftComment",comment:t}),n(o)),!0}}),addProseMirrorPlugins:()=>[(0,s.h)()]})},47296:(t,e,n)=>{n.d(e,{b:()=>u});var o=n(22905),s=n(63867),r=n(97255),a=n(53907),i=n(15342),l=n(91242),d=n(47665);let c=()=>{let t=document.createElement("span");t.classList.add("collaboration-cursor__caret","streaming-cursor"),t.setAttribute("style","border-color: var(--chakra-colors-trueblue-100)");let e=document.createElement("div");return e.classList.add("collaboration-cursor__label","streaming-cursor__label"),e.setAttribute("style","background-color: var(--chakra-colors-trueblue-100); color: var(--chakra-colors-trueblue-400)"),t.insertBefore(e,null),t},u=o.YY.create({name:"aiGeneration",addOptions:()=>({provider:null}),addStorage:()=>({generationEnabled:!1}),onCreate(){let{provider:t}=this.options;t&&t.awareness&&t.awareness.on("change",()=>{if(!t.awareness)return;let e=!1;for(let[n,o]of t.awareness.getStates())o.isStreaming&&n!==t.awareness.clientID&&(e=!0);let n=(0,i.KA)();(0,a.kg)(n.getState())!==e&&n.dispatch((0,a.gR)(e))})},addCommands(){return{setAIGenerationRunning:t=>()=>{var e,n;return this.storage.generationEnabled=t,null==(n=this.options.provider)||null==(e=n.awareness)||e.setLocalStateField("isStreaming",t),!0}}},addProseMirrorPlugins(){let{storage:t}=this;return[new s.k_({key:new s.hs("aiGeneration"),props:{decorations(e){if(!t.generationEnabled)return r.zF.empty;let n=[],s=e.doc.content.size-2,a=(0,o.eL)(e.doc.resolve(s),d.jg),i=a?(0,l.s)(e.doc.resolve(a.pos),-1):null;return i&&a&&(n.push(r.NZ.widget(i.from,c,{key:"sal",side:10})),n.push(r.NZ.node(a.pos,a.pos+a.node.nodeSize,{class:"ai-generate-streaming-card"}))),r.zF.create(e.doc,n)}}})]}})},60016:(t,e,n)=>{n.d(e,{T:()=>z,A:()=>N});var o=n(60122),s=n(22905),r=n(12364),a=n.n(r),i=n(62040),l=n(95578),d=n(73364);class c extends d.c{[Symbol.iterator](){return this.yarray[Symbol.iterator]()}values(){let t=this.yarray.length,e=-1;return{[Symbol.iterator]:()=>({next(){return++e===t?{value:void 0,done:!0}:{value:this.yarray.get(e),done:!1}}})}}forEach(t){return this.yarray.forEach(t)}set(t,e){return this.doc.transact(n=>{this.map.has(t)&&this.delete(t),this.yarray.push([{key:t,val:e}])}),e}delete(t){let e=0;for(let n of this.yarray){if(n.key===t){this.yarray.delete(e);break}e++}}get(t){let e=this.map.get(t);return e&&e.val}has(t){return this.map.has(t)}constructor(t){super(),this.yarray=t,this.doc=t.doc,this.map=new Map;let e=t.toArray();this.doc.transact(n=>{for(let n=e.length-1;n>=0;n--){let o=e[n];this.map.has(o.key)?t.delete(n):this.map.set(o.key,o)}}),t.observe(e=>{let n=new Map,o=Array.from(e.changes.added);e.changes.deleted.forEach(t=>{t.content.getContent().forEach(t=>{this.map.get(t.key)===t&&(this.map.delete(t.key),n.set(t.key,{action:"delete",oldValue:t.val}))})});let s=new Map;o.map(t=>t.content.getContent()).flat().forEach(t=>{s.set(t.key,t)});let r=new Set,a=t.toArray();this.doc.transact(e=>{for(let e=a.length-1;e>=0&&(s.size>0||r.size>0);e--){let o=a[e];if(r.has(o.key))r.delete(o.key),t.delete(e,1);else if(s.get(o.key)===o){let t=this.map.get(o.key);if(t)r.add(o.key),n.set(o.key,{action:"update",oldValue:t.val,newValue:o.val});else{let t=n.get(o.key);t&&"delete"===t.action?n.set(o.key,{action:"update",newValue:o.val,oldValue:t.oldValue}):n.set(o.key,{action:"add",newValue:o.val})}s.delete(o.key),this.map.set(o.key,o)}else s.has(o.key)&&(r.add(o.key),s.delete(o.key))}}),n.size>0&&this.emit("change",[n])})}}class u{run(t){}}class h extends u{createKeyValue(t,e){return new c(t.getArray(e))}getRestoreMap(t){return t.getMap("annotationsAbsolute")}run(t){let e=this.createKeyValue(t,"annotationsAbsoluteKV");for(let[n,o]of this.getRestoreMap(t).entries())e.set(n,o)}constructor(...t){super(...t),this.name="AnnotationsYKeyValue"}}class p{runMigrations(){let t=this.getMigrationsMap();for(let e of this.migrations)if(!this.hasRunMigration(e.name))try{e.run(this.document),t.set(e.name,!0)}catch(t){}}getMigrationsMap(){return this.document.getMap(p.ANNOTATION_MIGRATIONS_KEY)}hasRunMigration(t){return this.getMigrationsMap().get(t)||!1}constructor(t){this.migrations=[new h],this.document=t,this.document.transact(()=>{this.runMigrations()}),this.annotations=this.document.getMap("annotations"),this.annotationsAbsolute=new c(this.document.getArray("annotationsAbsoluteKV"))}}p.ANNOTATION_MIGRATIONS_KEY="annotationMigrations";var m=n(63867);class f{get id(){return this.decoration.type.spec.id}get from(){return this.decoration.from}get data(){return this.decoration.type.spec.data}get HTMLAttributes(){return this.decoration.type.attrs}toString(){return JSON.stringify({id:this.id,data:this.data,from:this.from,HTMLAttributes:this.HTMLAttributes})}constructor(t){this.decoration=t}}var g=n(53885),A=n(46814),v=n(9922),y=n.n(v),w=n(35342),M=n.n(w),b=n(831),k=n.n(b),S=n(97255),C=n(15607),I=n(56603),D=n(67200),P=n(47665),T=n(67864);function Y(t){let e=[];for(let n=t.length-1;n>=0;n--){let o=t[n];e.push({...o,prev:o.next,next:o.prev})}return e}class E{flushUndoQueue(){let{undoQueue:t}=this;return this.undoQueue=[],t}set(t,e){let n=this.map.get(t);return this.undoQueue.unshift({type:"set",key:t,next:n,prev:e}),this.map.set(t,e)}delete(t){let e=this.map.get(t);return void 0===e||this.undoQueue.unshift({type:"set",key:t,next:e,prev:void 0}),this.map.delete(t)}constructor(t){this.map=t,this.undoQueue=[]}}class B{persistRestoreMap(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={deletion:0,relToAbs:0,setting:0,total:0},o=performance.now();(e||this.hasChanges)&&(this.transactYDoc(()=>{let e=performance.now();for(let{key:t}of this.restoreMap)this.restoreMap.delete(t);n.deletion=performance.now()-e,this.map.forEach(e=>{let{id:o,pos:s,data:r}=e;try{let e=performance.now(),a=this.relToAbs(t,s);n.relToAbs+=performance.now()-e;let i=performance.now();this.restoreMap.set(o,{id:o,data:r,absPos:a}),n.setting+=performance.now()-i}catch(t){console.error("[Annotations] persistRestoreMap error: ",t.message)}})}),n.total=performance.now()-o,this.log("[Annotations] persistRestoreMap in ".concat(n.total,"ms"),{values:this.restoreMap.yarray.toArray(),performance:n}),this.hasChanges=!1)}flushMoveInstructionQueue(){let{moveInstructionMap:t}=this;return this.moveInstructionMap={},Object.values(t)}clearCutData(){this.cutData=null,this.filmstripCutData=null}getAnnotationsBetween(t,e,n){let o=[];for(let s of this.map.values())try{let r=this.relToAbs(t,s.pos);if(null===r)continue;e<=r&&r<n&&o.push({id:s.id,data:s.data,pos:r,relativePos:s.pos})}catch(t){console.warn("[Annotations] getAnnotationsBetween error: ",t.message)}return o}apply(t,e){if((0,D.LP)(t)){try{this.createDecorations(e)}catch(t){console.warn("[Annotations] handle remote change, not create decorations: ".concat(t.message))}return this}let n=t.getMeta(g.q);if(n){switch(n.type){case"addAnnotation":this.addAnnotation(n,e);break;case"restoreAnnotations":this.restoreAnnotations(n);break;case"clearAnnotations":this.clearAnnotations();break;case"deleteAnnotation":this.deleteAnnotation(n.id);break;case"refreshAnnotationDecorations":try{this.createDecorations(e)}catch(t){console.warn("could not create decorations: ".concat(t.message))}break;case"moveAnnotations":this.moveAnnotations(e,n.toMove)}return this.hasChanges=!0,this}switch(t.getMeta("uiEvent")){case"cut":this.handleCutTransaction(e,t);break;case"paste":this.handlePasteTransaction(e,t)}let o=t.getMeta("annotationEvent");switch(null==o?void 0:o.type){case"split-card":this.handleSplitCard(e,t,o);break;case"split-block":this.handleSplitBlock(e,t,o);break;case"join-forward":this.handleJoinForward(e,t,o);break;case"join-backward":this.handleJoinBackward(e,t,o);break;case"update-node-attrs":this.handleUpdateNodeAttrs(e,t,o);break;case"rearrange-cards":this.handleRearrangeCards(e,t,o);break;case"move":this.handleMove(e,t,o);break;case"merge-cards":this.handleMergeCards(e,t,o);break;case"drop":this.handleDropAnnotations(e,t,o);break;case"unwrap-node":this.handleUnwrapNode(e,t,o);break;case"wrap-nodes":this.handleWrapNodes(e,t,o);break;case"filmstrip-cut":this.handleFilmstripCut(e,t,o);break;case"filmstrip-paste":this.handleFilmstripPaste(e,t,o);break;default:t.getMeta("appendedTransaction")||(this.handleReplaceTransaction(e,t),this.handleReplaceAroundTransaction(e,t))}return t.docChanged&&(this.hasChanges=!0),this.handleLocalChange(t)}restore(t,e){e.forEach(e=>{let{next:n,key:o}=e;void 0===n?this.map.delete(o):this.map.set(o,{...n,pos:this.refreshRelativePos(t,n.pos)})}),this.persistRestoreMap(t,!0)}handleUnwrapNode(t,e,n){let{pos:o}=n,s=e.before.resolve(o),r=s.start(s.depth+1),a=e.before.resolve(r).end(),i=this.getAnnotationsBetween(t,r,a).map(e=>{let{id:n,relativePos:s}=e,a=this.relToAbs(t,s);return null===a?null:{id:n,newPos:o+(a-r)}}).filter(t=>!!t);this.log("%c[Annotations] unwrap node","color: green",{tr:e,pos:o,start:r,end:a,toMove:i}),i.length>0&&this.enqueueMoveInstructions(i)}handleWrapNodes(t,e,n){let{start:o,end:s,level:r}=n,a=this.getAnnotationsBetween(t,o,s).map(t=>{let{id:e,pos:n}=t;return{id:e,newPos:n+r}}).filter(t=>!!t);this.log("%c[Annotations] wrap nodes","color: green",{tr:e,start:o,end:s,toMove:a}),a.length>0&&this.enqueueMoveInstructions(a)}handleMergeCards(t,e,n){let{insertPos:o,contentPos:s}=n,r=e.before.nodeAt(s);if(!r)return void console.error("[AnnotationState] trying to merge cards, but cannot resolve content wrapper");let a=this.getAnnotationsBetween(t,s,s+r.nodeSize).map(t=>{let{id:e,pos:n}=t;return{id:e,newPos:o+(n-s-1)}});this.log("%c[Annotations] merge cards","color: green",{transaction:e,insertPos:o,contentPos:s,toMove:a}),a.length>0&&this.enqueueMoveInstructions(a)}handleRearrangeCards(t,e,n){let{rearrangedCardPositions:o,insertPos:s}=n,r=o.flatMap(n=>{let{newPos:o,oldPos:s}=n,r=e.before.resolve(s);return this.getAnnotationsBetween(t,s,s+r.nodeAfter.nodeSize).map(t=>{let{id:e,pos:n}=t;return{id:e,newPos:o+(n-s)}})}),a=[],i=(0,P.aJ)(e.before);if(i){let n=o[0].oldPos,r=Math.min(n,s),l=Math.max(n,s);a=i.flatMap(n=>{let{node:s,pos:a}=n;if(!(a>=r&&a<=l&&!o.find(t=>t.id===s.attrs.id)))return[];{let n=e.before.resolve(a),o=a+n.nodeAfter.nodeSize;return this.getAnnotationsBetween(t,a,o).map(t=>{let{id:n,pos:o}=t;return{id:n,newPos:e.mapping.map(o)}})}})}this.log("%c[Annotations] rearrange cards","color: green",{transaction:e,rearrangedCardPositions:o,annotationsInRearrangedCards:r,jumpedAnnotations:a});let l=[...r,...a];l.length>0&&this.enqueueMoveInstructions(l)}handleMove(t,e,n){let{insertPos:o,insertPosRaw:s,pos:r,end:a}=n,i=this.getAnnotationsBetween(t,r,a).map(t=>{let{id:e,pos:n}=t;return{id:e,newPos:o+(n-r)}}),l=this.getAnnotationsBetween(t,Math.min(s,a),Math.max(s,r)).map(t=>{let{id:n,pos:o}=t;return{id:n,newPos:e.mapping.map(o)}});this.log("%c[Annotations] move","color: green",{transaction:e,insertPos:o,insertPosRaw:s,pos:r,end:a,annotationsInCard:i,jumpedAnnotations:l});let d=[...i,...l];d.length>0&&this.enqueueMoveInstructions(d)}handleUpdateNodeAttrs(t,e,n){let{pos:o}=n,s=e.doc.nodeAt(o);if(!s)return;let r=this.getAnnotationsBetween(t,o,o+s.nodeSize).map(t=>{let{id:e,pos:n}=t;return{id:e,newPos:n}});this.log("%c[Annotations] update node attrs","color: green",{transaction:e,pos:o,toMove:r}),r.length>0&&this.enqueueMoveInstructions(r)}handleJoinBackward(t,e,n){let{atBeginning:o,joinPos:s}=n;if(!o)return;let r=e.before.resolve(s),a=e.before.resolve(r.before()),i=a.nodeBefore,l=a.nodeAfter;if(!i||!l)return;let d=a.pos+l.nodeSize,c=a.pos-i.nodeSize,u=t.selection.from;this.log("%c[Annotations] join backward","color: green",{transaction:e,prevBlock:i,nextBlock:l,nextBlockPos:a.pos,nextBlockEnd:d,prevBlockPos:c,joinPoint:u});let h=this.getAnnotationsBetween(t,a.pos,d);if(0===h.length)return void this.enqueueRefreshDecorations();0===l.content.size?(h.forEach(t=>{let{id:e}=t;return this.undoableMap.delete(e)}),requestAnimationFrame(()=>{this.writeUndoStack(t)})):this.enqueueMoveInstructions(h.map(t=>{let{id:e,pos:n}=t,o=Math.max(n-a.pos-1,0);return{id:e,newPos:(0===i.content.size?c:u)+o}}))}handleJoinForward(t,e,n){let{atEnd:o,joinPos:s}=n;if(!o)return;let r=e.before.resolve(s),{pos:a,node:i}=(0,C.TK)(r,t=>t.isBlock)[0],l=e.before.resolve(r.after()),d=l.nodeAfter;if(!d)return;let c=l.pos+d.nodeSize;this.log("%c[Annotations] join forward","color: green",{sel:t.selection,prevBlock:i,transaction:e,deleteAnnotations:!!d.isAtom,joinPos:r.pos,prevBlockPos:a,nextBlockPos:l.pos,nextBlock:d});let u=this.getAnnotationsBetween(t,a,a+i.nodeSize),h=this.getAnnotationsBetween(t,l.pos,c);if(0===h.length&&0===u.length)return void this.enqueueRefreshDecorations();let p=e=>{e.forEach(t=>{let{id:e}=t;return this.undoableMap.delete(e)}),requestAnimationFrame(()=>{this.writeUndoStack(t)})};d.isAtom&&i.content.size>0?p(h):0===i.content.size?p(u):this.enqueueMoveInstructions(h.map(t=>{let{id:e,pos:n}=t,o=Math.max(n-l.pos-1,0);return{id:e,newPos:(0===i.content.size?a:s)+o}}))}handleSplitBlock(t,e,n){let{splitPos:o,atBeginning:s}=n;if(s)return void this.enqueueRefreshDecorations();let r=e.before.resolve(o),{pos:a,node:i}=(0,C.TK)(r,t=>t.isBlock)[0],{$from:l}=t.selection,d=(0,C.TK)(l,t=>t.isBlock)[0],c=this.getAnnotationsBetween(t,o,a+i.nodeSize).map(t=>{let{id:e,pos:n}=t,s=n-o;return{id:e,newPos:d.pos+(0===s?s:s+1)}});c.length>0?this.enqueueMoveInstructions(c):this.enqueueRefreshDecorations(),this.log("%c[Annotations] split block","color: green",{sel:t.selection,transaction:e,splitPos:o,toMove:c,$before:r})}handleSplitCard(t,e,n){let{splitPos:o}=n,s=e.before.resolve(o),r=(0,C.TK)(s,P.jg)[0];if(!r)return;let a=r.pos,i=r.pos+r.node.nodeSize,l=this.getAnnotationsBetween(t,a,i).map(t=>{let{id:n,pos:s}=t;return{id:n,newPos:s===o?e.mapping.map(s+1)-1:e.mapping.map(s)}});this.log("%c[Annotations] split card","color: green",{transaction:e,splitPos:o,parentEnd:i,toMove:l}),this.enqueueMoveInstructions(l)}handlePasteTransaction(t,e){if(!this.cutData&&!this.filmstripCutData)return;let n=e.steps.find(t=>"replace"===t.jsonID);if(!n)return;let{from:o,to:s,slice:{openStart:r}}=n,a=t.doc.resolve(n.from),i=s===o?o:o+1,l=null==a.nodeBefore&&a.parent.isBlock,d=!r||l;if(this.log("%c[Annotations] paste transaction","color: green",{transaction:e,insertPos:o,resolved:a,isPasteBeginning:l,pasteType:this.cutData?"cut":"filmstrip-cut"}),this.cutData){let t=this.cutData;this.cutData=null;let e=t.toMove.map(t=>{let{id:e,offset:n}=t;return{id:e,newPos:i+(d?n:Math.max(0,n))}});e&&e.length>0&&(this.log("[Annotations] paste from cut final move",e),this.enqueueMoveInstructions(e))}else if(this.filmstripCutData){let n=this.filmstripCutData;this.filmstripCutData=null;let o=i-1;for(;o<t.doc.nodeSize;){let e=t.doc.nodeAt(o);if(e&&(0,P.jg)(e))break;o++}let s=this.getMoveInstructionsForFilmstripPaste(e,n,o);s&&s.length>0&&(this.log("[Annotations] paste from filmstrip cut final move",s),this.enqueueMoveInstructions(s))}}getMoveInstructionsForFilmstripPaste(t,e,n){if(!e)return;let o=(0,s.xe)(t.doc,P.jg);if(!o)return;let r=t.doc.resolve(n).depth,a=o.filter(e=>{let{pos:n}=e;return t.doc.resolve(n).depth===r}),i=a.findIndex(t=>t.pos===n);if(-1===i)return;let l=a.slice(i);return e.flatMap(t=>{let{cardIndex:e,annotations:n}=t;return n.map(t=>{let{id:n,offset:o}=t,s=l[e];if(s)return{id:n,newPos:s.pos+o}}).filter(t=>!!t)})}handleFilmstripPaste(t,e,n){if(!this.cutData&&!this.filmstripCutData)return;let{insertPos:o}=n;if(this.cutData){let t=this.cutData;this.cutData=null;let n=t.toMove.map(t=>{let{id:e,offset:n}=t;return{id:e,newPos:o+n}});n&&n.length>0&&(this.log("[Annotations] filmstripPaste from cut final move",{tr:e,cutData:t,moveInstructions:n}),this.enqueueMoveInstructions(n))}else if(this.filmstripCutData){let t=this.filmstripCutData;this.filmstripCutData=null;let n=this.getMoveInstructionsForFilmstripPaste(e,t,o);n&&n.length>0&&(this.log("%c[Annotations] filmstripPaste from filmstrip cut final move","color: green",{tr:e,filmstripCutData:t,moveInstructions:n}),this.enqueueMoveInstructions(n))}}handleFilmstripCut(t,e,n){this.cutData=null,this.filmstripCutData=n.deleted.map(n=>{let{cardIndex:o,pos:s}=n,r=e.before.resolve(s),a=s+r.nodeAfter.nodeSize;return{cardIndex:o,annotations:this.getAnnotationsBetween(t,s,a).map(t=>{let{id:e,pos:n}=t;return{id:e,offset:n-s}})}}),this.log("%c[Annotations] filmstripCut","color: green",{tr:e,filmstripCutData:this.filmstripCutData})}handleCutTransaction(t,e){let n=e.steps.find(t=>"replace"===t.jsonID);if(!n)return;this.filmstripCutData=null;let{from:o,to:s}=n,r=t.doc.resolve(o),a=null==r.nodeAfter&&null==r.nodeBefore&&r.parent.isBlock,i=this.getAnnotationsBetween(t,o-!!a,s),l=i.map(e=>{let n=this.relToAbs(t,e.relativePos);return{id:e.id,offset:n-o}});this.cutData={slice:n.slice,toMove:l},this.log("%c[Annotations] cut transaction","color:green",{isWholeBlock:a,resolved:r,transaction:e,annotations:i,moveData:l})}handlePrependContentToBlock(t,e){let n=e.steps.find(t=>"replace"===t.jsonID);if(!n)return;let{from:o}=n,s=e.before.resolve(o);if(!s.nodeAfter)return;let r=this.getAnnotationsBetween(t,o,o+s.nodeAfter.nodeSize).map(n=>{let{id:s,relativePos:r}=n,a=this.relToAbs(t,r);return{id:s,newPos:a===o?e.mapping.map(a+1)-1:e.mapping.map(a)}});r.length>0&&(this.log("%c[Annotations] replace transaction - prepend content","color:green",{tr:e,annotationsToMove:r}),this.enqueueMoveInstructions(r))}handleReplaceTransaction(t,e){let n=e.steps.find(t=>"replace"===t.jsonID);if(!n)return;let{from:o,to:s}=n,r=e.before.resolve(o),a=e.before.resolve(s),i=r.parent!==a.parent,l=0==n.slice.content.size,d=0===r.parentOffset&&s>=o+r.parent.nodeSize-2,c=d&&l;if(0===a.parentOffset&&a.depth===r.depth+1&&a.pos-r.pos==1)return this.handlePrependContentToBlock(t,e);let u=!1;if(i){var h;let n=[...c?[]:this.getAnnotationsBetween(t,o-r.parentOffset-1,o).map(e=>{let{id:n,relativePos:o}=e;return{id:n,newPos:this.relToAbs(t,o)}}),...this.getAnnotationsBetween(t,s,s+(null==(h=a.nodeAfter)?void 0:h.nodeSize)+1).map(n=>{let{id:o,relativePos:s}=n;return{id:o,newPos:e.mapping.map(this.relToAbs(t,s))}})];this.log("[Annotations] multiline to move",n),n.length>0&&(u=!0,this.enqueueMoveInstructions(n))}let p=this.getAnnotationsBetween(t,o-(c||i&&0===r.parentOffset?1:0),s);p.length>0&&(u=!0,this.log("[Annotations] to delete",p),p.forEach(t=>{this.undoableMap.delete(t.id)})),u&&(this.log("%c[Annotations] replace transaction","color:green",{tr:e,annotationsToDelete:p,isWholeBlock:c,isMultiline:i,replacingEntireFromBlock:d,replacingWithNothing:l}),requestAnimationFrame(()=>{this.writeUndoStack(t)}))}handleReplaceAroundTransaction(t,e){let n=M()(e.steps.filter(t=>"replaceAround"===t.jsonID),e=>{let{from:n,to:o}=e;return this.getAnnotationsBetween(t,n,o)}),o=k()(n,t=>t.id).map(t=>{let{id:n,pos:o}=t;return{id:n,newPos:e.mapping.map(o)}});return o.length>0&&this.log("%c[Annotations] replaceAround transaction","color:green",{tr:e,moveInsturctions:o}),0!==o.length&&(this.enqueueMoveInstructions(o),!0)}clearAnnotations(){this.transactYDoc(()=>{this.map.forEach((t,e)=>{this.map.delete(e)})})}restoreAnnotations(t){this.log("%c[Annotations] restoreAnnotations","color: green",t);let{toRestore:e}=t;this.clearAnnotations(),this.enqueueMoveInstructions(e.filter(t=>{let{absPos:e}=t;return null!=e}).map(t=>{let{absPos:e,id:n}=t;return{id:n,newPos:e}}))}addAnnotation(t,e){this.log("%c[Annotations] addAnnotation","color: green",t);let{pos:n,id:o,data:s}=t,r=this.absToRel(e,n);this.map.set(o,{id:o,pos:r,data:s})}deleteAnnotation(t){this.log("%c[Annotations] deleteAnnotation","color: green",t),this.map.delete(t)}moveAnnotations(t,e){let{map:n}=this;this.log("%c[Annotations] moveAnnotations","color: green",e),this.transactYDoc(()=>{e.forEach(e=>{let{id:o,newPos:s}=e,r=n.get(o)||{id:o};this.undoableMap.set(o,{...r,pos:this.absToRel(t,s)})})}),this.writeUndoStack(t)}writeUndoStack(t){let e=o.Mj.getState(t).undoManager;if(0===e.undoStack.length)return;let n=this.undoableMap.flushUndoQueue();if(0===n.length)return;let s=e.undoStack[e.undoStack.length-1],r="annotations",a=s.meta.get(r)||[];a.length>0&&this.log("[Annotations] existing undo stack",{existing:a,toWrite:n,stack:e.undoStack});let i=[...n,...a];s.meta.set(r,i),this.log("[Annotations] writing to undo stack",i)}createDecorations(t){let{map:e}=this.options;this.refreshDecorations=!1;let n=[],o=[];e.forEach((e,s)=>{let r=(0,I.d_)(t,e.pos);if(null==r)return;let a=t.doc.nodeAt(r);a&&((null==a?void 0:a.isInline)?n.push(S.NZ.inline(r,r+1,{class:"debug-comment-cursor"})):n.push(S.NZ.node(r,r+a.nodeSize,{class:"debug-comment-block"}))),o.push({id:s,data:e.data,relativePos:e.pos,pos:r})}),t.doc.descendants((t,e,s)=>(!(e>0)||!!(0,T.cE)(s)||!!(0,T.cE)(t))&&(o.filter(n=>n.pos>=e&&n.pos<e+t.nodeSize).forEach(o=>{let{id:s,data:r}=o;n.push(S.NZ.node(e,e+t.nodeSize,{},{isAnnotation:!0,id:s,data:r}))}),!0)),this.decorations=S.zF.create(t.doc,n),this.annotations=o}handleDropAnnotations(t,e,n){let{dragging:{origNodePos:o,inBlock:s,inCard:r},droppedBlockPos:a}=n,i=[];s.forEach(t=>{let e=t.pos-o;i.push({id:t.id,newPos:a+e})}),this.getAnnotationsBetween(t,a,a+1).filter(t=>!i.find(e=>e.id===t.id)).forEach(t=>{i.push({id:t.id,newPos:e.mapping.map(t.pos)})}),r.filter(t=>!i.find(e=>e.id===t.id)).forEach(t=>{let n=e.mapping.map(t.pos);i.push({newPos:n,id:t.id})}),this.log("%c[Annotations] handleDropAnnotations","color: green",{action:n,tr:e,toMove:i}),i.length>0&&this.enqueueMoveInstructions(i)}handleLocalChange(t){let e=[...this.decorations.find(void 0,void 0,t=>t.isAnnotation&&this.moveInstructionMap[t.id])],n=this.decorations.remove(y()(e)).map(t.mapping,t.doc).add(t.doc,e);return this.decorations=n,this}absToRel(t,e){let n=(0,I.JO)(t,e);if(!n)throw Error("Y.State non initialized");return n}relToAbs(t,e){return(0,I.d_)(t,e)}refreshRelativePos(t,e){let{doc:n,type:s,binding:r}=o.pJ.getState(t),a=(0,A.bL)(n,s,e,r.mapping);return(0,A.Bw)(a,s,r.mapping)}enqueueMoveInstructions(t){t.forEach(t=>{this.moveInstructionMap[t.id]&&console.error("[AnnotationState] trying to enqueue two move instructions for annotation with targetId=".concat(t.id)),this.moveInstructionMap[t.id]=t})}enqueueRefreshDecorations(){this.refreshDecorations=!0}transactYDoc(t){this.options.document.transact(t)}log(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];l.of.get("debugComments")?console.log(...e):console.debug(...e)}constructor(t){this.options=t,this.decorations=S.zF.empty,this.annotations=[],this.refreshDecorations=!1,this.hasChanges=!1,this.filmstripCutData=null,this.cutData=null,this.moveInstructionMap={},this.map=t.map,this.restoreMap=t.restoreMap,this.undoableMap=new E(this.map)}}let q=t=>{let e=a()(t=>{g.q.getState(t.state).persistRestoreMap(t.state)},500);return new m.k_({key:g.q,state:{init:()=>new B(t),apply:(t,e,n,o)=>e.apply(t,o)},view:()=>({update(t){e(t)}}),props:{transformPasted(e){var n;let o=this.getState(t.editor.state),s=null==(n=e.content.firstChild)?void 0:n.attrs.docId;return s&&s!==t.editor.gammaDocId&&o.clearCutData(),e},handleDOMEvents:{copy(t){return this.getState(t.state).clearCutData(),!1}},decorations(e){let{decorations:n,annotations:o}=this.getState(e);return t.onUpdate&&t.onUpdate(n.find().map(t=>new f(t)),o),n}}})},z=s.YY.create({name:"annotation",onCreate(){let t=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];l.of.get("debugComments")?console.log(...e):console.debug(...e)};this.options.document.on("afterAllTransactions",e=>{let n=g.q.getState(this.editor.view.state),o=n.flushMoveInstructionQueue();o.length>0?(t("%c[Annotations] afterAllTransactions handling queued moves","color:pink",o),this.editor.commands.moveAnnotations(o)):n.refreshDecorations&&(t("%c[Annotations] afterAllTransactions refreshDecorations","color:pink"),this.editor.commands.refreshDecorations())});let e=g.q.getState(this.editor.state);window.gammaAnnotations=e;let n=o.Mj.getState(this.editor.state).undoManager;setTimeout(()=>{n.on("stack-item-popped",t=>{let o=t.stackItem.meta.get("annotations");if(!o)return void e.persistRestoreMap(this.editor.state,!0);let{undoStack:s,redoStack:r}=n;"undo"===t.type&&r.length>0?r[r.length-1].meta.set("annotations",Y(o)):"redo"===t.type&&s.length>0&&s[s.length-1].meta.set("annotations",Y(o)),e.restore(this.editor.state,o)})},0),e.map.observe(a()(()=>{t("[Annotations] map observe -> resfreshDecorations"),this.editor.commands.refreshDecorations()})),this.editor.commands.refreshDecorations()},addCommands:()=>({restoreAnnotations:t=>e=>{let{dispatch:n,tr:o}=e;return n&&(o.setMeta(g.q,{type:"restoreAnnotations",toRestore:Object.values(t)}),n(o)),!0},updateAttributes:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return n=>{var o,r;let{tr:a,state:i,dispatch:l}=n,d=null,c=null,u=(o="string"==typeof t?t:t.name,(r=i.schema).nodes[o]?"node":r.marks[o]?"mark":null);return!!u&&("node"===u&&(d=(0,s.Pg)(t,i.schema)),"mark"===u&&(c=(0,s.I2)(t,i.schema)),l&&a.selection.ranges.forEach(t=>{let n=t.$from.pos,o=t.$to.pos;i.doc.nodesBetween(n,o,(t,s)=>{d&&d===t.type&&a.setNodeMarkup(s,void 0,{...t.attrs,...e}).setMeta("annotationEvent",{type:"update-node-attrs",pos:s}),c&&t.marks.length&&t.marks.forEach(r=>{if(c===r.type){let i=Math.max(s,n),l=Math.min(s+t.nodeSize,o);a.addMark(i,l,c.create({...r.attrs,...e}))}})})}),!0)}},wrapWithAnnotations:(t,e)=>n=>{let{state:o,tr:s,dispatch:r}=n,a=o.schema.nodes[t],{$from:l,$to:d}=o.selection,c=l.blockRange(d),u=c&&(0,i.oM)(c,a,e);if(!u||!c)return!1;let{start:h,end:p}=c;return!r||(s.wrap(c,u).setMeta("annotationEvent",{type:"wrap-nodes",start:h,end:p,level:1}).scrollIntoView(),!0)},moveAnnotations:t=>e=>{let{dispatch:n,tr:o}=e;return n&&(o.setMeta(g.q,{type:"moveAnnotations",toMove:t}),n(o)),!0},clearAnnotations:()=>t=>{let{dispatch:e,tr:n}=t;return e&&(n.setMeta(g.q,{type:"clearAnnotations"}),e(n)),!0},refreshDecorations:()=>t=>{let{dispatch:e,tr:n}=t;return e&&(n.setMeta(g.q,{type:"refreshAnnotationDecorations"}),e(n)),!0},addAnnotation:t=>{let{pos:e,id:n,data:o}=t;return t=>{let{dispatch:s,state:r}=t;return s&&r.tr.setMeta(g.q,{type:"addAnnotation",id:n,data:o,pos:e}),!0}},deleteAnnotation:t=>e=>{let{dispatch:n,state:o}=e;return n&&o.tr.setMeta(g.q,{type:"deleteAnnotation",id:t}),!0}}),addProseMirrorPlugins(){let{document:t,onUpdate:e}=this.options,n=new p(t);return[q({document:t,editor:this.editor,map:n.annotations,restoreMap:n.annotationsAbsolute,onUpdate:e})]}}),N=z},60080:(t,e,n)=>{n.d(e,{O:()=>l});var o=n(60122),s=n(32380),r=n(86083),a=n(22905),i=n(38934);let l=a.YY.create({name:"collaboration",priority:i.y.Collaboration,addOptions:()=>({document:null,field:"default",fragment:null}),onCreate(){this.editor.extensionManager.extensions.find(t=>"history"===t.name)&&console.warn('[tiptap warn]: "@tiptap/extension-collaboration" comes with its own history support and is not compatible with "@tiptap/extension-history".')},addCommands:()=>({undo:()=>t=>{let{tr:e,state:n,dispatch:r}=t;return e.setMeta("preventDispatch",!0),0!==o.Mj.getState(n).undoManager.undoStack.length&&(!r||(0,s.tN)(n)||!0)},redo:()=>t=>{let{tr:e,state:n,dispatch:r}=t;return e.setMeta("preventDispatch",!0),0!==o.Mj.getState(n).undoManager.redoStack.length&&(!r||(0,s.ZS)(n)||!0)}}),addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Mod-y":()=>this.editor.commands.redo(),"Shift-Mod-z":()=>this.editor.commands.redo()}},addProseMirrorPlugins(){let t=this.options.fragment?this.options.fragment:this.options.document.getXmlFragment(this.options.field);return[(0,r.YZ)(t),(0,s.$J)()]}})},64877:(t,e,n)=>{n.d(e,{c:()=>m});var o=n(60122),s=n(22905),r=n(12364),a=n.n(r),i=n(62040),l=n(48993),d=n(95578),c=n(15342),u=n(95889),h=n(74677),p=n(47665);let m=s.YY.create({name:"editCardAI",onTransaction(t){var e;let{transaction:n}=t;if(!(!n.docChanged||n.getMeta("isEditCardVariant"))&&this.editor.isEditable&&d.of.get("editCard2"))if(null==(e=n.getMeta(o.pJ))?void 0:e.isUndoRedoOperation)g(n);else{if(!1===n.getMeta("addToHistory"))return;f(n)}}}),f=a()(t=>{try{let e=(0,c.KA)(),n=e.getState(),o=(0,l.yL)(n);if(0===Object.keys(o).length)return;(0,h.A)(t).forEach(n=>{let r={from:n.newStart,to:n.newEnd},a=(0,s.Nx)(t.doc,r,t=>(0,p.jg)(t)&&!!o[t.attrs.id]);a.length&&a.forEach(t=>{var n;let{node:s}=t,r=s.attrs.id;console.debug("Clearing suggestions for card",r),null===u.zS||void 0===u.zS||u.zS.track(u.VV.AI_CARD_VARIATION_KEPT,{cardId:r,variantId:o[r].selected,isOriginal:null==(n=o[r].variants.find(t=>t.id===o[r].selected))?void 0:n.isOriginal,interactionId:o[r].interactionId,source:"edit"}),e.dispatch((0,l.YB)({cardId:r}))})})}catch(t){console.error("[caught] EditCard clearSuggestions error",t)}},250),g=t=>{try{let e=t.steps[0];if(!e||!(e instanceof i.Ln))return;let n=e.slice.content,o=(0,c.KA)(),s=o.getState(),r=(0,l.yL)(s);if(0===Object.keys(r).length)return;n.descendants(t=>{if(!(0,p.jg)(t))return;let e=t.attrs.id,n=r[e];if(!n)return;let s=n.variants.find(e=>JSON.stringify(e.card)===JSON.stringify(t.toJSON()));s&&o.dispatch((0,l.S6)({cardId:e,variantId:s.id}))})}catch(t){console.error("[caught] EditCard updateVariations error",t)}}},65286:(t,e,n)=>{n.d(e,{$:()=>c});var o=n(22905),s=n(67864),r=n(63867),a=n(97255),i=n(29608);let l=new r.hs("mobileAnnotationPluginKey");class d{apply(t,e){let n=t.getMeta(l);return n&&"setPos"in n&&(this.pos=n.setPos),this}constructor(){this.pos=null}}let c=o.YY.create({name:"mobileAnnotation",addCommands:()=>({setMobileAddBlockComment:t=>e=>{let{dispatch:n,tr:o,view:r}=e;if(!n)return!1;if(null===t)return o.setMeta(l,{setPos:null}),n(o),!0;let{clientX:a,clientY:i}=t,d=r.posAtCoords({left:a,top:i});if(null===d)return!0;let c=(0,s.CS)(d.inside,r);if(!c)return!1;let u=r.coordsAtPos(c.pos),h=a-u.left,p=i-u.top;return o.setMeta(l,{setPos:{pos:c.pos,end:c.end,offsetX:h,offsetY:p}}),n(o),!0}}),addProseMirrorPlugins(){var t;return[(t=this.editor,new r.k_({key:l,state:{init:()=>new d,apply:(t,e,n,o)=>e.apply(t,o)},props:{handleDOMEvents:{click(e,n){if(!(0,i.Xb)())return!1;if(n.target.closest("[data-comments-wrapper]"))return;let o=l.getState(e.state);o.pos||(o.timeout?(clearTimeout(o.timeout),o.timeout=null,t.commands.setMobileAddBlockComment(n)):o.timeout=setTimeout(()=>{o.timeout=null},300))}},decorations(t){let e=l.getState(t).pos;if(null===e)return a.zF.empty;let n=a.NZ.node(e.pos,e.end,{},{isMobileAnnotation:!0,type:"show-buttons",offsetX:e.offsetX,offsetY:e.offsetY});return a.zF.create(t.doc,[n])}}}))]}})},67839:(t,e,n)=>{n.d(e,{F:()=>i});var o=n(22905),s=n(63867),r=n(38934);let a=()=>new s.k_({key:new s.hs("undoHistoryPlugin"),appendTransaction(t,e,n){if(t.some(t=>!1==t.getMeta("addToHistory"))){let t=n.tr;return t.setMeta("addToHistory",!1),t}return null}}),i=o.YY.create({name:"undoHistory",priority:r.y.UndoHistory,addProseMirrorPlugins:()=>[a()],addCommands:()=>({noUndo:()=>t=>{let{tr:e}=t;return e.setMeta("addToHistory",!1),!0}})})},70651:(t,e,n)=>{n.d(e,{d:()=>i});var o=n(22905),s=n(63867),r=n(15440);let a=()=>new s.k_({key:r.G,state:{init:()=>new r.Z,apply:(t,e,n,o)=>e.apply(t,o)}}),i=o.YY.create({name:"aiModifications",onCreate(){this.options.document.on("afterAllTransactions",t=>{let e=r.G.getState(this.editor.view.state);e&&e.flushMoveInstructionQueue(this.editor.view.state)})},addProseMirrorPlugins:()=>[a()],addCommands:()=>({setInteractionRange:(t,e)=>n=>{let{tr:o}=n;return o.setMeta("aiModificationAction",{type:"setInteractionRange",rangeId:t,range:e}),!0}})})},82636:(t,e,n)=>{n.d(e,{H:()=>i});var o=n(60122),s=n(22905),r=n(64084),a=n(15342);let i=s.YY.create({name:"filmstrip",onCreate(){let t=o.Mj.getState(this.editor.state).undoManager;t.on("stack-item-popped",e=>{let{undoStack:n,redoStack:o}=t,s=e.stackItem.meta.get("filmstripState");if(!s)return;let i=(0,r.Tz)((0,a.KA)().getState());"undo"===e.type&&o.length>0?o[o.length-1].meta.set("filmstripState",i):"redo"===e.type&&n.length>0&&n[n.length-1].meta.set("filmstripState",i),(0,a.KA)().dispatch((0,r.Uy)(s))})}})}}]);
//# sourceMappingURL=7847-f4f46d5ba86d706d.js.map